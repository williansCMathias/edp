var settings = {
	effect: "overlay"
}
, cart = null
, helper = {
	openCart: function() {
			var width = $(cart).width() * -1;
			"push" == settings.effect && $(settings.wrapper).animate({
					marginLeft: width
			}),
			$(cart).animate({
					right: 0
			}),
			$(".sta-cart-overlay").fadeIn(),
			$("body").addClass("menuOpen")
	},
	closeCart: function() {
			var width = $(cart).width() * -1;
			"push" == settings.effect && $(settings.wrapper).animate({
					marginLeft: 0
			}),
			$(cart).animate({
					right: width - 10
			}),
			$(".sta-cart-overlay").fadeOut(),
			$(".sta-cart-comfirm").fadeOut(),
			$("body").removeClass("menuOpen")
	},
	fillCart: function() {
			setTimeout(function() {
					vtexjs.checkout.getOrderForm().done(function(orderForm) {
							var i, totalItems, totalShipping, totalDiscount, items = orderForm.items, itemsQtd = items.length;
							$(".sta-cart-title h3 span, .openCart .info").text(itemsQtd);
							for (var i = 0; i < orderForm.totalizers.length; i++)
									"Items" == orderForm.totalizers[i].id ? totalItems = orderForm.totalizers[i].value : "Shipping" == orderForm.totalizers[i].id ? totalShipping = orderForm.totalizers[i].value : "Discounts" == orderForm.totalizers[i].id && (totalDiscount = orderForm.totalizers[i].value);
							void 0 != totalItems ? $(cart).find(".sta-cart-sub strong").html("R$ " + helper.toReal(totalItems)) : $(cart).find(".sta-cart-sub strong").html("R$ " + helper.toReal("000")),
							void 0 != totalShipping && ($(cart).find(".sta-cart-freight").css("display", "block"),
							$(cart).find(".sta-cart-freight strong").html("R$ " + helper.toReal(totalShipping))),
							void 0 != totalDiscount && ($(cart).find(".sta-cart-discount").css("display", "block"),
							$(cart).find(".sta-cart-discount strong").html("R$ " + helper.toReal(totalDiscount))),
							$(cart).find(".sta-cart-total strong").html("R$ " + helper.toReal(orderForm.value)),
							orderForm.totalizers;
							var btnOpenCart = '<i class="ico-cart"></i>';
							if (btnOpenCart += '<div class="info">' + itemsQtd + "</div>",
							$(cart).find(".sta-cart-items > ul").html(""),
							items.length > 0)
									for ($(".sta-cart-resume a").removeClass("disabled"),i = 0; i < items.length; i++) {
											var cartItem = "<li>";
											cartItem += '<div class="sta-cart-pdt-image">',
											cartItem += '<img src="' + items[i].imageUrl.replace("55-55", "80-80") + '" />',
											cartItem += "</div>",
											cartItem += '<div class="sta-cart-pdt-info">',
											cartItem += "<h4>" + items[i].name + "</h4> ",
											cartItem += '<button class="remove-item" data-index="' + i + '">',
											cartItem += '<i class="ico-lixeira"></i>',
											cartItem += "</button>",
											cartItem += '<div class="sta-cart-pdt-other-info">',
											cartItem += '<div class="prices">',
											cartItem += '<p class="bestPrice">R$ ' + helper.toReal(items[i].sellingPrice) + "</p>",
											cartItem += "</div>",
											cartItem += '<div class="sta-cart-pdt-qtd">',
											cartItem += '<ul class="list-count list-count-cart" data-index="' + i + '">',
											cartItem += '<li class="minus"><a href="#" class="qty-less">-</a></li>',
											cartItem += '<li class="result"><input type="text" value="' + items[i].quantity + '" name="quantity" class="qty-field field quantity" min="1" max="100" step="1" /></li>',
											cartItem += '<li class="plus"><a href="#" class="qty-more">+</a></li>',
											cartItem += "</ul>",
											cartItem += '<div class="loaded" style="display:none">Aguarde...</div>',
											cartItem += "</div>",
											cartItem += "</div>",
											cartItem += "</div>",
											cartItem += "</li>",
											$(cart).find(".sta-cart-items > ul").append(cartItem)
									}
							else
									$(".sta-cart-resume a").addClass("disabled")
					})
			}, 500)
	},
	addItem: function(el) {
			var urlTest = ["javascript", ":", "alert('Por favor, selecione o modelo desejado.');"].join("")
				, url = $(el).attr("href")
				, qtlyP = $(".qtdValue").val();
			if (url = url.replace("qty=1", "qty=" + qtlyP),
			url.indexOf("sku") >= 0) {
					parseInt(url.split("sku=")[1].split("&")[0])
			} else {
					el.parents(".buy-button-normal").attr("id")
			}
			if (url == urlTest)
					return alert("Por favor, selecione o modelo desejado."),
					!1;
			el.text("Aguarde..."),
			$.ajax({
					url: url.replace("true", "false"),
					type: "GET",
					crossDomain: !0,
					dataType: "html"
			}).done(function() {
					helper.fillCart(),
					helper.openCart(),
					el.text("Comprar"),
					setTimeout(function() {}, 3e3)
			})
	},
	changeItem: function(itemIndex, quantity, btnContainer) {
			vtexjs.checkout.getOrderForm().done(function(orderForm) {
					vtexjs.catalog.getProductWithVariations(orderForm.items[itemIndex].productId).done(function(data) {
							Array.from(data.skus, function(item) {
									item.sku == orderForm.items[itemIndex].id && (quantity > item.availablequantity ? (btnContainer.next(".loaded").hide(),
									btnContainer.show(),
									alert("Estoque m√°ximo atingido")) : vtexjs.checkout.getOrderForm().then(function(orderForm) {
											var updateItem = (orderForm.items[itemIndex],
											{
													index: itemIndex,
													quantity: quantity
											});
											return vtexjs.checkout.updateItems([updateItem], null, !1)
									}).done(function(orderForm) {
											helper.fillCart(),
											btnContainer.next(".loaded").hide(),
											btnContainer.show()
									}))
							})
					})
			})
	},
	removeItem: function(index) {
			confirm("Deseja realmente remover o item do carrinho?") && vtexjs.checkout.getOrderForm().then(function(orderForm) {
					var item = orderForm.items[index];
					return item.index = index,
					vtexjs.checkout.removeItems([item])
			}).done(function(orderForm) {
					helper.fillCart()
			})
	},
	toReal: function(val) {
			return val /= 100,
			val = val.toFixed(2).toString().replace(".", ",")
	},
	modalComfirmBild: function() {
			$(".sta-cart-comfirm-overlay").fadeIn(),
			$(".sta-cart-comfirm").fadeIn(),
			$("body").addClass("menuOpen"),
			helper.modalComfirmRemove()
	},
	modalComfirmRemove: function() {
			$(".sta-cart-comfirm-overlay, .sta-keepShop, .close").on("click", function(e) {
					e.preventDefault(),
					$(".sta-cart-comfirm-overlay").fadeOut(),
					$(".sta-cart-comfirm").fadeOut(),
					$("body").removeClass("menuOpen"),
					setTimeout(function() {
							$(".sta-cart-comfirm-overlay").remove(),
							$(".sta-cart-comfirm").remove()
					}, 600)
			})
	},
	modalComfirm: function() {
			$(".sta-cart-overlay").fadeIn(),
			$(".sta-cart-comfirm").fadeIn(),
			$("body").addClass("menuOpen")
	}
};
!function($) {
	$.fn.vtexcart = function(parameters) {
			var el = this;
			settings = $.extend(settings, parameters);
			var cartHtml = '<div class="sta-cart-overlay"></div>';
			cartHtml += '<div class="sta-cart-container">',
			cartHtml += '<div class="sta-cart-title">',
			cartHtml += '<button class="sta-cart-close"><i class="ico-close"></i></button>',
			cartHtml += "<h3>Meu Carrinho (<span>0</span>)</h3>",
			cartHtml += "</div>",
			cartHtml += '<div class="sta-cart-items">',
			cartHtml += "<ul></ul>",
			cartHtml += "</div>",
			cartHtml += '<div class="sta-cart-resume">',
			cartHtml += '<span class="sta-cart-sub"><em>Subtotal:</em> ',
			cartHtml += "<strong>R$ 0,00</strong>",
			cartHtml += "</span>",
			cartHtml += '<span class="sta-cart-freight"><em>Frete:</em> ',
			cartHtml += "<strong>R$ 0,00</strong>",
			cartHtml += "</span>",
			cartHtml += '<span class="sta-cart-discount"><em>Desconto:</em> ',
			cartHtml += "<strong>R$ 0,00</strong>",
			cartHtml += "</span>",
			cartHtml += '<span class="sta-cart-total"><em>Total:</em> ',
			cartHtml += " <strong> R$0,00</strong>",
			cartHtml += "</span> ",
			cartHtml += '<a class="checkoutLink" href="/checkout/#/email" title="Finalizar compra">Finalizar compra<i class="ico-thin-arrow"></i></a>',
			cartHtml += '<a class="cartLink" href="/checkout/#/cart" title="Ver detalhes do carrinho">Ver detalhes do carrinho</a>',
			cartHtml += "</div>",
			cartHtml += "</div>";
			var miniCartHtml = '<a href="#" class="openCart"><span></span></a>';
			$(el).append(cartHtml),
			settings.cartButton && $(settings.cartButton).append(miniCartHtml),
			cart = $(el).find(".sta-cart-container"),
			helper.fillCart(),
			$(settings.buyButton).on("click", function(event) {
					event.preventDefault(),
					helper.addItem($(this))
			}),
			$(".sta-cart-container").on("click", ".list-count-cart a", function(event) {
					event.preventDefault();
					var btnAction = $(this)
						, dataIndex = btnAction.closest(".list-count-cart").attr("data-index")
						, qtyField = btnAction.closest(".list-count-cart").find(".qty-field")
						, quantity = parseInt(qtyField.val(), 10) || 0
						, qtyMin = qtyField.attr("min")
						, qtyMax = qtyField.attr("max");
					btnAction.hasClass("qty-less") ? quantity != qtyMin && quantity-- : qtyMax > quantity && quantity++,
					btnContainer = btnAction.parents(".list-count"),
					btnContainer.next(".loaded").show(),
					btnContainer.hide(),
					helper.changeItem(dataIndex, quantity, btnContainer)
			}),
			$(".openCart").on("click", function(event) {
					event.preventDefault(),
					$(".sta-cart-items li").length ? helper.openCart() : window.location = window.location = "https://" + window.location.hostname + "/checkout/#/cart"
			}),
			$(".sta-cart-close, .sta-cart-overlay, .sta-keepShop").on("click", function(event) {
					event.preventDefault(),
					helper.closeCart()
			}),
			$(".sta-cart-container").on("click", ".remove-item", function() {
					var index = $(this).data("index");
					helper.removeItem(index)
			}),
			$(".sta-cart-resume a").on("click", function() {
					return !$(this).hasClass("disabled")
			}),
			$(".sta-cart-freight button").click(function() {
					$(this).hide(),
					$(".sta-cart-freight input").show()
			})
	}
}(jQuery),
$(function() {
	$("body").vtexcart({
			buyButton: $(".buy-button.buy-button-ref"),
			wrapper: $(".wrapper"),
			effect: "overlay",
			cartButton: $(".sta-cart")
	}),
	$(document).on("keypress", ".list-count .qty-field", function(e) {
			var tecla = window.event ? event.keyCode : e.which;
			return tecla > 47 && tecla < 58 || (8 == tecla || 0 == tecla)
	})
})
